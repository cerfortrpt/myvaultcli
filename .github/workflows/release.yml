name: Release Python CLI and Update Homebrew Formula

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller keyring cryptography

      - name: Build binary with PyInstaller
        run: |
          pyinstaller main.spec
          cp dist/main vaultfingerprint
          chmod +x vaultfingerprint

      - name: Generate SHA256
        id: hash
        run: |
          sha256=$(shasum -a 256 vaultfingerprint | awk '{print $1}')
          echo "sha256=$sha256" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: vaultfingerprint
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: "Automated release for version ${{ github.ref_name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Formula
        run: |
          FORMULA_PATH="Formula/myvault.rb"
          BINARY_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/vaultfingerprint"
          SHA256="${{ steps.hash.outputs.sha256 }}"

          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/cerfortrpt/homebrew-tools taprepo
          cd taprepo

          sed -i '' "s|url \".*\"|url \"$BINARY_URL\"|" $FORMULA_PATH
          sed -i '' "s|sha256 \".*\"|sha256 \"$SHA256\"|" $FORMULA_PATH
          sed -i '' "s|version \".*\"|version \"${{ github.ref_name }}\"|" $FORMULA_PATH || echo "version \"${{ github.ref_name }}\"" >> $FORMULA_PATH

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -am "Update to ${{ github.ref_name }}"
          git push origin main

